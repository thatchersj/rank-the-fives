<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eton Fives Rankings</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; min-height: 20px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .actions a {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; cursor:pointer; text-decoration:none; color:#111; font-size:14px;
    }
    .actions a:hover { background:#f6f6f6; }
    .note { margin: 12px 0 14px; color:#666; font-size: 14px; line-height:1.4; }
    .small { font-size: 12px; color:#666; margin-top:6px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 0 0 12px; }
    .controls input, .controls select {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; font-size:14px; min-width: 220px;
    }

    .table-wrap{
      border:1px solid #ddd; border-radius:14px; overflow:auto;
      max-height: calc(100vh - 260px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      -webkit-overflow-scrolling: touch;
    }

    table { border-collapse: separate; border-spacing: 0; }
    #rankings{ width: max-content; min-width:100%; background:white; }
    #rankings thead th{
      background:#fafafa;
      border-bottom:1px solid #ddd;
      font-weight:600;
      white-space: nowrap;
      padding: 6px 10px;
      position: sticky; top: 0; z-index: 5;
      cursor: default;
      user-select: none;
      touch-action: manipulation;
    }
    #rankings thead th.sortable { cursor: pointer; }
    #rankings thead th.tournament { cursor: pointer; }
    #rankings td{
      padding: 6px 10px;
      border-right:1px solid #eee;
      border-bottom:1px solid #eee;
      white-space: nowrap;
      background:white;
      text-align: center;
    }
    #rankings tbody tr:nth-child(even) td{ background:#fcfcfc; }

    /* Sticky first 4 columns */
    #rankings th:nth-child(1), #rankings td:nth-child(1){
      position: sticky; left: 0; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      font-variant-numeric: tabular-nums;
      background: inherit;
    }
    #rankings th:nth-child(2), #rankings td:nth-child(2){
      position: sticky; left: 60px; z-index: 6; min-width:70px; max-width:70px;
      border-right:1px solid #ddd;
      background: inherit;
      text-align: center;
    }
    #rankings th:nth-child(3), #rankings td:nth-child(3){
      position: sticky; left: 130px; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      background: inherit;
    }
    #rankings th:nth-child(4), #rankings td:nth-child(4){
      position: sticky; left: 190px; z-index: 6; min-width:190px; max-width:190px;
      border-right:1px solid #ddd;
      font-weight:600;
      background: inherit;
      text-align: left;
    }

    #rankings td:nth-child(1), #rankings td:nth-child(2), #rankings td:nth-child(3), #rankings td:nth-child(4),
    #rankings th:nth-child(1), #rankings th:nth-child(2), #rankings th:nth-child(3), #rankings th:nth-child(4){
      background: white;
    }
    #rankings tbody tr:nth-child(even) td:nth-child(1),
    #rankings tbody tr:nth-child(even) td:nth-child(2),
    #rankings tbody tr:nth-child(even) td:nth-child(3),
    #rankings tbody tr:nth-child(even) td:nth-child(4){
      background: #fcfcfc;
    }

    .result-cell{ text-align:center; font-weight:600; }

    /* Colour coding (works on mobile because it's inline classes on TD) */
    .res-W{ background:#c6efce !important; color:#006100 !important; }   /* Winner */
    .res-F{ background:#d9e1f2 !important; color:#1f4e79 !important; }   /* Final */
    .res-SF{ background:#fff2cc !important; color:#7f6000 !important; }  /* Semi */
    .res-QF{ background:#fce4d6 !important; color:#7f2a00 !important; }  /* Quarter */
    .res-L16{ background:#fde9d9 !important; color:#7f2a00 !important; } /* Last 16 */
    .res-NQ{ background:#f8cbad !important; color:#833c0c !important; }  /* Non-qual */
    .res-P{ background:#e7e6e6 !important; color:#444 !important; }      /* P */
    .res-UNK{ background:#f2f2f2 !important; color:#555 !important; font-weight:500; }

    th.sorted-asc::after { content:" ▲"; font-weight:700; }
    th.sorted-desc::after { content:" ▼"; font-weight:700; }
  
    /* Modal for match details */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 1000;
    }
    .modal{
      width: min(720px, 100%);
      max-height: 80vh;
      overflow:auto;
      background: white;
      border-radius: 16px;
      border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal header{
      position: sticky; top: 0; z-index: 2;
      background: white;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .modal h2{ margin:0; font-size: 18px; }
    .modal .close{
      border: 1px solid #ccc; border-radius: 10px; padding: 8px 10px;
      background: white; cursor: pointer; font-size: 14px;
    }
    .modal .content{ padding: 12px 16px 16px; }
    .match-round{ margin: 14px 0 6px; font-weight: 700; }
    .match{
      padding: 10px 12px; border: 1px solid #eee; border-radius: 12px;
      margin: 8px 0; background: #fafafa;
    }
    .match .line{ margin: 4px 0; }
    .pill{
      display:inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #ddd; background: white; font-size: 12px;
      margin-right: 8px;
    }
    .pill-won{ background:#c6efce; border-color:#9ccc9c; color:#0b5a0b; }
    .pill-lost{ background:#f8cbad; border-color:#f3a981; color:#7f2a00; }

    .elo-pill{ font-variant-numeric: tabular-nums; font-weight:700; margin-right:0; }
    .unc-low{ background:#c6efce; border-color:#9ccc9c; color:#0b5a0b; }
    .unc-med{ background:#fff2cc; border-color:#e6d88a; color:#7f6000; }
    .unc-high{ background:#f8cbad; border-color:#f3a981; color:#7f2a00; }


  </style>
</head>

<body>
  <header>
    <div>
      <h1>Eton Fives Rankings</h1>
      <div class="meta" id="status">Loading…</div>
    </div>
    <div class="actions">
      <a href="./downloads/rankings_latest.xlsx" download>Download XLSX</a>
      <a href="./downloads/rankings_latest.csv" download>Download CSV</a>
      <a
        href="https://github.com/thatchersj/rank-the-fives/issues/new?template=submit_results.yml&title=New%20tournament%20results&labels=recalculate"
        target="_blank" rel="noopener"
      >Submit new results</a>
    </div>
  </header>

  <div class="note">
    Tap a column header to sort (mobile supported). Search to find a player.
    <div class="small">Codes: <b>W</b>, <b>F</b>, <b>SF</b>, <b>QF</b>, <b>L16</b>, <b>NQ</b>.</div>
  </div>

  <div class="controls">
    <select id="snapshotSelect" aria-label="As of tournament"></select>
    <input id="searchBox" type="search" placeholder="Search (rank/initial/surname)..." autocomplete="off" />
    <span class="small" id="count"></span>
  </div>

  <div class="table-wrap">
    <table id="rankings">
      <thead><tr id="theadRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <noscript>
    <p><b>This page needs JavaScript enabled</b> to load rankings.</p>
  </noscript>

  <script>
    (function(){
      const TWO_DP_COLS = new Set(["poss","rpa","pc","pc2"]);
function formatMaybe2dp(col, val){
  if (!TWO_DP_COLS.has(String(col).toLowerCase())) return val;
  if (val === null || val === undefined || val === "") return val;
  const num = Number(val);
  if (!Number.isFinite(num)) return val;
  return num.toFixed(2);
}


function displayResultValue(val){
  // Hide 'P' results in the table (treat as blank)
  if (val === "P" || val === "p") return "";
  return val;
}

const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const searchBox = document.getElementById("searchBox");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.querySelector("#rankings tbody");
      const table = document.getElementById("rankings");

      function normalizeResult(v) {
        const s = (v ?? "").toString().trim().toUpperCase();
        if (!s || s === "P") return "";
        return s.replace(/\s+/g, ""); // "L 16" -> "L16"
      }
      function resultClass(v) {
        const key = normalizeResult(v);
        if (!key) return null;
        if (["W","F","SF","QF","NQ","L16","P"].includes(key)) return "res-" + key;
        return "res-UNK";
      }
            function uncertaintyClass(sigma){
        const s = Number(sigma);
        if (!Number.isFinite(s)) return 'unc-med';
        if (s < 140) return 'unc-low';
        if (s < 250) return 'unc-med';
        return 'unc-high';
      }

function looksLikeResultColumn(colName) {
        // expected like "13 N" / "13N" / "13 K" etc
        return /^\d{2}\s*[NKL]$/i.test(colName.trim().replace(/\s+/g, " "));
      }

      async function loadData() {
        // IMPORTANT: relative to the current page URL (works on GH Pages project sites)
        const latestUrl = new URL("data/rankings_latest.json", window.location.href);
        const resLatest = await fetch(latestUrl.toString(), { cache: "no-store" });
        if (!resLatest.ok) throw new Error(`Failed to load ${latestUrl} (${resLatest.status} ${resLatest.statusText})`);
        const latest = await resLatest.json();
        if (!Array.isArray(latest) || latest.length === 0) throw new Error("No data found in rankings_latest.json");

        // Snapshots (optional)
        let snapshots = null;
        try {
          const snapsUrl = new URL("data/rankings_snapshots.json", window.location.href);
          const resSnaps = await fetch(snapsUrl.toString(), { cache: "no-store" });
          if (resSnaps.ok) snapshots = await resSnaps.json();
        } catch (e) {
          console.warn('No rankings_snapshots.json', e);
        }

        return { latest, snapshots };
      }

      async function loadMatches() {
        const url = new URL("data/matches_latest.json", window.location.href);
        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) {
          console.warn("No matches_latest.json", res.status, res.statusText);
          return null;
        }
        return await res.json();
      }

      function render(data) {
        const cols = Object.keys(data[0] || {}).filter(c => c !== "EloSigma");
        window.__CURRENT_COLS__ = cols;
        theadRow.innerHTML = "";
        tbody.innerHTML = "";

        cols.forEach(c => {
          const th = document.createElement("th");
          th.textContent = c;

          if (!looksLikeResultColumn(c)) {
            th.classList.add("sortable");
          } else {
            th.classList.add("tournament");
          }

          theadRow.appendChild(th);
        });

        const resultCols = new Set(cols.filter(looksLikeResultColumn));

        data.forEach(row => {
          const tr = document.createElement("tr");
          cols.forEach(c => {
            const td = document.createElement("td");
            const val = row[c] ?? "";
            const displayVal = formatMaybe2dp(c, val);
            if (c === "Elo") {
              const pill = document.createElement("span");
              pill.className = `pill elo-pill ${uncertaintyClass(row["EloSigma"])}`;
              pill.textContent = (val === null || val === undefined || val === "") ? "" : String(Math.round(Number(val)));
              td.appendChild(pill);
            } else {
              td.textContent = displayVal;
            }

            if (resultCols.has(c)) {
              td.classList.add("result-cell");
          td.textContent = displayResultValue(td.textContent);

              const cls = resultClass(val);
              if (cls) td.classList.add(cls);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        countEl.textContent = `${data.length} players`;
      }

      function getCellValue(row, idx) {
        const td = row.children[idx];
        return td ? td.textContent.trim() : "";
      }

      function detectType(val) {
        const n = Number(val);
        if (!isNaN(n) && val !== "") return "number";
        return "string";
      }

      function sortBy(colIdx, asc) {
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const type = detectType(getCellValue(rows[0], colIdx));
        rows.sort((a,b) => {
          const va = getCellValue(a,colIdx);
          const vb = getCellValue(b,colIdx);
          if (type === "number") {
            return asc ? (Number(va)-Number(vb)) : (Number(vb)-Number(va));
          }
          return asc ? va.localeCompare(vb) : vb.localeCompare(va);
        });
        rows.forEach(r => tbody.appendChild(r));
      }

      function enableSortAndSearch() {
        let currentSort = { idx: 0, asc: true };

        theadRow.addEventListener("click", (ev) => {
          const th = ev.target.closest("th");
          if (!th) return;
          const idx = Array.from(theadRow.children).indexOf(th);
          if (idx < 0) return;

          const headerText = (th.textContent || "").trim();
          const norm = headerText.toString().replace(/\s+/g," ").trim();
          const isTournament = looksLikeResultColumn(norm);

          if (isTournament) {
            openTournamentDrawFromHeaderText(headerText);
            return;
          }

          // Normal sortable columns
          const asc = (currentSort.idx === idx) ? !currentSort.asc : true;
          currentSort = { idx, asc };

          Array.from(theadRow.children).forEach(h => h.classList.remove("sorted-asc","sorted-desc"));
          th.classList.add(asc ? "sorted-asc" : "sorted-desc");

          sortBy(idx, asc);
        });

        searchBox.addEventListener("input", () => {
          const q = searchBox.value.trim().toUpperCase();
          const rows = Array.from(tbody.querySelectorAll("tr"));
          let shown = 0;
          rows.forEach(tr => {
            const cols = window.__CURRENT_COLS__ || [];
            const idxRank = cols.indexOf("Rank") >= 0 ? cols.indexOf("Rank") : 0;
            const idxInit = cols.indexOf("Initial");
            const idxSur = cols.indexOf("Surname");
            const rank = (tr.children[idxRank]?.textContent || "").toUpperCase();
            const init = (tr.children[idxInit]?.textContent || "").toUpperCase();
            const sur = (tr.children[idxSur]?.textContent || "").toUpperCase();
            const hay = `${rank} ${init} ${sur}`;
            const ok = !q || hay.includes(q);
            tr.style.display = ok ? "" : "none";
            if (ok) shown++;
          });
          countEl.textContent = `${shown} / ${rows.length} players`;
        });

        // Default sort by Rank (column 1 at top)
        sortBy(0, true);
      }

      
      function openMatchModal(title, sub, bodyHtml) {
        const backdrop = document.getElementById("matchModalBackdrop");
        const titleEl = document.getElementById("matchModalTitle");
        const subEl = document.getElementById("matchModalSub");
        const bodyEl = document.getElementById("matchModalBody");
        titleEl.textContent = title;
        subEl.textContent = sub || "";
        bodyEl.innerHTML = bodyHtml || "";
        backdrop.style.display = "flex";
        backdrop.setAttribute("aria-hidden", "false");
      }

      function closeMatchModal() {
        const backdrop = document.getElementById("matchModalBackdrop");
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
      }

      function escapeHtml(s) {
        return (s ?? "").toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      
      function normaliseHeader(s){
        return (s ?? "").toString().replace(/\s+/g," ").trim().toUpperCase();
      }

      function openTournamentDrawFromHeaderText(headerText){
        const matchesData = window.__MATCHES_DATA__;
        if (!matchesData || !matchesData.tournaments) return;

        const norm = normaliseHeader(headerText);

        // Prefer direct lookup by header text, then try colToKey mapping if present
        let tourn =
          matchesData.tournaments[norm] ||
          matchesData.tournaments[norm.replace(/\s+/g, "")] ||
          null;

        if (!tourn && matchesData.colToKey) {
          const key = matchesData.colToKey[norm] || matchesData.colToKey[norm.replace(/\s+/g, "")];
          tourn = key ? matchesData.tournaments[key] : null;
        }

        if (!tourn) return;

        const title = `${tourn.tournament}`;
        const subtitle = `Draw`;

        const order = ["L16", "QF", "SF", "F"];
        const byRound = {};
        for (const m of (tourn.matches || [])){
          const r = m.round || "Other";
          (byRound[r] ||= []).push(m);
        }

        let body = "";
        let first = 1;

        const nqTeams = Array.isArray(tourn.nqTeams) ? tourn.nqTeams : [];
        if (nqTeams.length){
          body += `<div class="match-round">Non-Qualifiers</div>`;
          body += `<div class="match">`;
          for (const t of nqTeams){
            if (!t.team) continue;
            if (first === 1){
               first = 0
            } else {
               body += `<br>`;
            }
            body += `<span class="pill">${escapeHtml(t.team)}</span>`;
          }
          body += `</div>`;
        }

          const roundNames = { L16: "Last 16", QF: "Quarter-Finals", SF: "Semi-Finals", F: "Final" };
        for (const r of order){
          const list = byRound[r] || [];
          if (!list.length) continue;
          body += `<div class="match-round">${escapeHtml(roundNames[r])}</div>`;
          for (const m of list){
            const wTeam = m.winnerTeam || "";
            const lTeam = m.loserTeam || "";
            const score = (m.score || "").toString().trim();
            body += `<div class="match">`
              + `<div class="line"><b>${escapeHtml(wTeam)}</b> beat ${escapeHtml(lTeam)}</div>`
              + (score ? `<div class="line">${escapeHtml(score)}</div>` : ``)
              + `</div>`;
          }
        }

        const others = Object.keys(byRound).filter(r => !order.includes(r));
        for (const r of others){
          const list = byRound[r] || [];
          if (!list.length) continue;
          body += `<div class="match-round">${escapeHtml(r)}</div>`;
          for (const m of list){
            const wTeam = m.winnerTeam || "";
            const lTeam = m.loserTeam || "";
            const score = (m.score || "").toString().trim();
            body += `<div class="match">`
              + `<div class="line"><b>${escapeHtml(wTeam)}</b> beat ${escapeHtml(lTeam)}</div>`
              + (score ? `<div class="line">${escapeHtml(score)}</div>` : ``)
              + `</div>`;
          }
        }

        if (!body) body = `<div class="match">No draw data found for this tournament.</div>`;

        // Use the modal that actually exists on the page
        openMatchModal(title, subtitle, body);
      }

      function attachCellClicks(matchesData) {
        const table = document.getElementById("rankings");
        const tbody = table.querySelector("tbody");
        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent);

        const roundOrder = ["L16", "QF", "SF", "F"];
        const roundNames = { L16: "Last 16", QF: "Quarter-Finals", SF: "Semi-Finals", F: "Final" };

        tbody.addEventListener("click", (ev) => {
          const td = ev.target.closest("td");
          if (!td) return;
          const tr = td.parentElement;
          const tds = Array.from(tr.children);
          const colIdx = tds.indexOf(td);
          const colName = (headers[colIdx] || "").trim();

          if (!/^\d{2}\s+[NKL]$/i.test(colName)) return;

          const result = (td.textContent || "").trim();
          if (!result) return;

          const idxInit = headers.indexOf('Initial');
          const idxSur = headers.indexOf('Surname');
          const initial = (tds[idxInit]?.textContent || "").trim().toUpperCase();
          const surname = (tds[idxSur]?.textContent || "").trim().toUpperCase();
          const playerKey = `${initial}|${surname}`;

          const tourn = matchesData?.tournaments?.[colName];
          const tournFull = tourn?.tournament || colName;

          let body = "";
          if (!tourn) {
            body = `<div class="match">No match detail found for ${escapeHtml(colName)}.</div>`;
            openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
            return;
          }

          const inNQ = Array.isArray(tourn.nq) && tourn.nq.includes(playerKey);
          const nqTeams = Array.isArray(tourn.nqTeams) ? tourn.nqTeams : [];
          const hitNQTeam = nqTeams.find(t => Array.isArray(t.players) && t.players.includes(playerKey));
          const nqTeamDisplay = (hitNQTeam && hitNQTeam.team) ? hitNQTeam.team : null;

          const matches = (tourn.matches || []).filter(m => {
            const w = Array.isArray(m.winners) ? m.winners : [];
            const l = Array.isArray(m.losers) ? m.losers : [];
            return w.includes(playerKey) || l.includes(playerKey);
          });

          // Determine the player's team (player + partner) for this tournament
          const prettySurname = (surname || "").slice(0,1) + (surname || "").slice(1).toLowerCase();
          const prettyPlayer = `${initial}.${prettySurname}`;
          let playerTeam = null;
          if (matches.length > 0) {
            const m0 = matches[0];
            const won0 = (m0.winners || []).includes(playerKey);
            playerTeam = won0 ? (m0.winnerTeam || null) : (m0.loserTeam || null);
          }
          if (!playerTeam) playerTeam = prettyPlayer;

          body += `<div class="match"><span class="pill">${escapeHtml(result)}</span><b>${escapeHtml((inNQ && nqTeamDisplay) ? nqTeamDisplay : playerTeam)}</b></div>`;

          if (matches.length === 0 && !inNQ) {
            body += `<div class="match">No match lines found for this player in this tournament.</div>`;
            openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
            return;
          }

          const byRound = {};
          for (const m of matches) {
            const r = m.round || "UNK";
            byRound[r] = byRound[r] || [];
            byRound[r].push(m);
          }

          for (const r of roundOrder) {
            const list = byRound[r];
            if (!list || list.length === 0) continue;
            body += `<div class="match-round">${escapeHtml(roundNames[r])}</div>`;
            for (const m of list) {
              const score = escapeHtml(m.score || "");
              const won = (m.winners || []).includes(playerKey);
              body += `<div class="match">` +
                      `<div class="line"><span class="pill ${won ? "pill-won" : "pill-lost"}">${escapeHtml(won ? "Won" : "Lost")}</span><i>vs</i> ${escapeHtml(won ? (m.loserTeam || "") : (m.winnerTeam || ""))}</div>` +
                      (score ? `<div class="line">${score}</div>` : ``) +
                      `</div>`;
            }
          }

          openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
        });

        document.getElementById("matchModalClose")?.addEventListener("click", closeMatchModal);
        document.getElementById("matchModalBackdrop")?.addEventListener("click", (e) => {
          if (e.target && e.target.id === "matchModalBackdrop") closeMatchModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeMatchModal();
        });
      }

      (async function main(){
        try {
          const [loaded, matchesData] = await Promise.all([loadData(), loadMatches()]);
          window.__MATCHES_DATA__ = matchesData;

        const snapshotSelect = document.getElementById('snapshotSelect');
        const snaps = (loaded.snapshots && Array.isArray(loaded.snapshots.snapshots)) ? loaded.snapshots.snapshots : [];
        if (snapshotSelect) {
          snapshotSelect.innerHTML = '';
          const optLatest = document.createElement('option');
          optLatest.value = 'latest';
          optLatest.textContent = 'Latest';
          snapshotSelect.appendChild(optLatest);
          snaps.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.key;
            opt.textContent = s.label;
            snapshotSelect.appendChild(opt);
          });
          snapshotSelect.value = 'latest';
          snapshotSelect.addEventListener('change', () => {
            const v = snapshotSelect.value;
            if (v === 'latest') {
              render(loaded.latest);
              statusEl.textContent = 'Showing latest';
            } else {
              const snap = snaps.find(x => x.key === v);
              if (snap && Array.isArray(snap.records)) {
                render(snap.records);
                statusEl.textContent = `As of ${snap.label}`;
              }
            }
            // reset search + sort
            searchBox.value = '';
            sortBy(0, true);
          });
        }

          render(loaded.latest);
          enableSortAndSearch();
          attachCellClicks(matchesData);
          statusEl.textContent = "Showing latest";
        } catch (e) {
          console.error(e);
          statusEl.textContent = (e && e.message) ? e.message : "Failed to load rankings data.";
        }
      })();
    })();
  </script>

  <div class="modal-backdrop" id="matchModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="matchModal">
      <header>
        <div>
          <h2 id="matchModalTitle">Match details</h2>
          <div class="small" id="matchModalSub"></div>
        </div>
        <button class="close" id="matchModalClose" type="button">Close</button>
      </header>
      <div class="content" id="matchModalBody"></div>
    </div>
  </div>

</body>
</html>