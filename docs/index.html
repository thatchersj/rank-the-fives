<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eton Fives Rankings</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; min-height: 20px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .actions a { border:1px solid #ccc; border-radius:10px; padding:10px 12px; background:white; text-decoration:none; color:#111; font-size:14px; }
    .actions a:hover { background:#f6f6f6; }
    .note { margin: 12px 0 14px; color:#666; font-size: 14px; line-height:1.4; }
    .small { font-size: 12px; color:#666; margin-top:6px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 0 0 12px; }
    .controls input { border:1px solid #ccc; border-radius:10px; padding:10px 12px; background:white; font-size:14px; min-width: 220px; }

    .table-wrap{
      border:1px solid #ddd; border-radius:14px; overflow:auto;
      max-height: calc(100vh - 260px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      -webkit-overflow-scrolling: touch;
    }

    table { border-collapse: separate; border-spacing: 0; }
    #rankings{ width: max-content; min-width:100%; background:white; }
    #rankings thead th{
      background:#fafafa; border-bottom:1px solid #ddd; font-weight:600; white-space: nowrap;
      padding: 6px 10px; position: sticky; top: 0; z-index: 5;
      cursor: pointer; user-select: none; touch-action: manipulation;
    }
    #rankings td{ padding: 6px 10px; border-right:1px solid #eee; border-bottom:1px solid #eee; white-space: nowrap; background:white; }
    #rankings tbody tr:nth-child(even) td{ background:#fcfcfc; }

    /* Sticky first 3 columns */
    #rankings th:nth-child(1), #rankings td:nth-child(1){ position: sticky; left: 0; z-index: 6; min-width:60px; max-width:60px; border-right:1px solid #ddd; text-align:right; font-variant-numeric: tabular-nums; }
    #rankings th:nth-child(2), #rankings td:nth-child(2){ position: sticky; left: 60px; z-index: 6; min-width:60px; max-width:60px; border-right:1px solid #ddd; text-align:center; }
    #rankings th:nth-child(3), #rankings td:nth-child(3){ position: sticky; left: 120px; z-index: 6; min-width:190px; max-width:190px; border-right:1px solid #ddd; font-weight:600; }

    .result-cell{ text-align:center; font-weight:600; }
    .res-W{ background:#c6efce !important; color:#006100 !important; }
    .res-F{ background:#d9e1f2 !important; color:#1f4e79 !important; }
    .res-SF{ background:#fff2cc !important; color:#7f6000 !important; }
    .res-QF{ background:#fce4d6 !important; color:#7f2a00 !important; }
    .res-L16{ background:#fde9d9 !important; color:#7f2a00 !important; }
    .res-NQ{ background:#f8cbad !important; color:#833c0c !important; }
    .res-P{ background:#e7e6e6 !important; color:#444 !important; }
    .res-UNK{ background:#f2f2f2 !important; color:#555 !important; font-weight:500; }

    th.sorted-asc::after { content:" ▲"; font-weight:700; }
    th.sorted-desc::after { content:" ▼"; font-weight:700; }

    /* Modal */
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; }
    .modal{ width: min(720px, 100%); background: white; border-radius: 22px; box-shadow: 0 18px 60px rgba(0,0,0,0.25); overflow: hidden; }
    .modal-head{ padding: 18px 18px 12px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px; border-bottom: 1px solid #eee; }
    .modal-title{ font-size: 28px; font-weight: 800; letter-spacing: 0.5px; }
    .modal-subtitle{ color:#666; margin-top: 2px; }
    .modal-close{ border:1px solid #ddd; background:white; border-radius: 14px; padding: 10px 14px; cursor:pointer; font-size: 16px; }
    .modal-body{ padding: 14px 18px 18px; max-height: min(70vh, 720px); overflow:auto; }

    .card{ border:1px solid #eee; border-radius: 18px; padding: 14px; margin: 10px 0; background:#fafafa; }
    .round{ font-size: 28px; font-weight: 800; margin: 16px 0 6px; }
    .match{ border:1px solid #eee; border-radius: 18px; padding: 14px; margin: 10px 0; background:white; }
    .line{ font-size: 22px; line-height:1.25; }
    .pill{ display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; background: white; font-size: 12px; margin-right: 8px; }
    .pill-won{ background:#c6efce; border-color:#9ccc9c; color:#0b5a0b; }
    .pill-lost{ background:#f8cbad; border-color:#f3a981; color:#7f2a00; }

    @media (max-width: 500px){
      .modal-title{ font-size: 22px; }
      .line{ font-size: 18px; }
      .round{ font-size: 22px; }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>Eton Fives Rankings</h1>
      <div class="meta" id="status">Loading…</div>
    </div>
    <div class="actions">
      <a href="./downloads/rankings_latest.xlsx" download>Download XLSX</a>
      <a href="./downloads/rankings_latest.csv" download>Download CSV</a>
      <a href="https://github.com/thatchersj/rank-the-fives/issues/new?template=submit_results.yml&title=New%20tournament%20results&labels=recalculate" target="_blank" rel="noopener">Submit new results</a>
    </div>
  </header>

  <div class="note">
    Tap a column header to sort (mobile supported). Search to find a player.
    <div class="small">Codes: <b>W</b>, <b>F</b>, <b>SF</b>, <b>QF</b>, <b>L16</b>, <b>NQ</b>, <b>P</b>.</div>
  </div>

  <div class="controls">
    <input id="searchBox" type="search" placeholder="Search (rank/initial/surname)" autocomplete="off" />
    <span class="small" id="count"></span>
  </div>

  <div class="table-wrap">
    <table id="rankings">
      <thead><tr id="theadRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="modalTitle">Match details</div>
          <div class="modal-subtitle" id="modalSubtitle"></div>
        </div>
        <button class="modal-close" id="modalClose">Close</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <noscript><p><b>This page needs JavaScript enabled</b> to load rankings.</p></noscript>

  <script>
    const __statusEl = document.getElementById("status");
    window.addEventListener("error", (e) => {
      if (__statusEl) __statusEl.textContent = "JavaScript error: " + (e?.message || "unknown");
    });
    window.addEventListener("unhandledrejection", (e) => {
      if (__statusEl) __statusEl.textContent = "JavaScript error: " + ((e?.reason && e.reason.message) ? e.reason.message : "unhandled rejection");
    });

    (function(){
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const searchBox = document.getElementById("searchBox");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.querySelector("#rankings tbody");
      const table = document.getElementById("rankings");

      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalClose = document.getElementById("modalClose");
      const modalTitle = document.getElementById("modalTitle");
      const modalSubtitle = document.getElementById("modalSubtitle");
      const modalBody = document.getElementById("modalBody");

      function normWs(s){
        return (s ?? "").toString().replace(/\s+/g, " ").trim();
      }
      function normColKey(s){
        return normWs(s).toUpperCase();
      }
      function escapeHtml(s){
        return (s ?? "").toString()
          .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
      }

      function normalizeResult(v){
        const s = (v ?? "").toString().trim().toUpperCase();
        return s ? s.replace(/\s+/g, "") : "";
      }
      function resultClass(v){
        const key = normalizeResult(v);
        if (!key) return null;
        if (["W","F","SF","QF","NQ","L16","P"].includes(key)) return "res-" + key;
        return "res-UNK";
      }
      function looksLikeResultColumn(colName){
        const k = normColKey(colName); // handles newlines on mobile
        return /^\d{2}\s*[NKL]$/i.test(k.replace(/\s+/g, " "));
      }

      async function fetchJsonRelative(rel){
        const url = new URL(rel, window.location.href);
        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load ${url} (${res.status} ${res.statusText})`);
        return await res.json();
      }

      function openModal(title, subtitle, bodyHtml){
        modalTitle.textContent = title;
        modalSubtitle.textContent = subtitle;
        modalBody.innerHTML = bodyHtml;
        modalBackdrop.style.display = "flex";
        modalBackdrop.setAttribute("aria-hidden","false");
      }
      function closeModal(){
        modalBackdrop.style.display = "none";
        modalBackdrop.setAttribute("aria-hidden","true");
      }
      modalClose.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (e)=>{ if (e.target === modalBackdrop) closeModal(); });

      let matchIndex = null; // {colToKey:{}, tournaments:{}}

      function resolveTournament(colName){
        if (!matchIndex) return null;
        const ckRaw = colName;
        const ck1 = normColKey(ckRaw);
        const ck2 = ck1.replace(/\s+/g, "");
        const map = matchIndex.colToKey || {};
        const tournKey = map[ckRaw] || map[ck1] || map[ck2];
        if (!tournKey) return null;
        const tourn = (matchIndex.tournaments || {})[tournKey];
        return tourn || null;
      }

      function renderTable(rows){
        const cols = Object.keys(rows[0] || {});
        theadRow.innerHTML = "";
        tbody.innerHTML = "";

        cols.forEach(c => {
          const th = document.createElement("th");
          th.textContent = normWs(c); // avoid newline headers on mobile
          theadRow.appendChild(th);
        });

        const resultCols = new Set(cols.filter(looksLikeResultColumn));

        rows.forEach(row => {
          const tr = document.createElement("tr");

          cols.forEach(c => {
            const td = document.createElement("td");
            const val = row[c] ?? "";
            td.textContent = val;

            if (resultCols.has(c)) {
              td.classList.add("result-cell");
              const cls = resultClass(val);
              if (cls) td.classList.add(cls);

              td.addEventListener("click", () => {
                if (!matchIndex) return;

                const initial = (row["Initial"] ?? "").toString().trim();
                const surname = (row["Surname"] ?? "").toString().trim();
                const playerKey = `${initial}.${surname}`.toUpperCase();

                const tourn = resolveTournament(c);
                const result = normalizeResult(val) || "UNK";
                const tournFull = tourn ? `${tourn.year} ${tourn.tournament}` : normWs(c);

                let topTeam = `${initial}.${surname}`;
                if (tourn) {
                  const inNQ = Array.isArray(tourn.nq) && tourn.nq.includes(playerKey);
                  const nqTeams = Array.isArray(tourn.nqTeams) ? tourn.nqTeams : [];
                  const hitNQTeam = nqTeams.find(t => Array.isArray(t.players) && t.players.includes(playerKey));
                  if (inNQ && hitNQTeam && hitNQTeam.team) topTeam = hitNQTeam.team;
                }

                let body = `<div class="card"><span class="pill">${escapeHtml(result)}</span><b>${escapeHtml(topTeam)}</b></div>`;

                if (!tourn) {
                  body += `<div class="match">No match detail found for this tournament column.</div>`;
                  openModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
                  return;
                }

                const matches = (tourn.matches || []).filter(m => {
                  const w = Array.isArray(m.winners) ? m.winners : [];
                  const l = Array.isArray(m.losers) ? m.losers : [];
                  return w.includes(playerKey) || l.includes(playerKey);
                });

                if (matches.length === 0) {
                  body += `<div class="match">No match lines found for this player in this tournament.</div>`;
                  openModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
                  return;
                }

                const byRound = {};
                for (const m of matches) {
                  const r = m.round || "UNK";
                  (byRound[r] ||= []).push(m);
                }

                const roundOrder = ["Last 16","Quarter-Finals","Semi-Finals","Final","UNK"];
                for (const r of roundOrder) {
                  const list = byRound[r];
                  if (!list || !list.length) continue;

                  body += `<div class="round">${escapeHtml(r)}</div>`;
                  for (const m of list) {
                    const winners = Array.isArray(m.winners) ? m.winners : [];
                    const won = winners.includes(playerKey);
                    const oppTeam = won ? (m.loserTeam || "") : (m.winnerTeam || "");
                    const score = (m.score || "").toString().trim();

                    body += `<div class="match">`
                      + `<span class="pill ${won ? "pill-won" : "pill-lost"}">${escapeHtml(won ? "Won" : "Lost")}</span>`
                      + `<div class="line"><b>${escapeHtml(won ? "beat" : "lost to")}</b> ${escapeHtml(oppTeam)}</div>`
                      + (score ? `<div class="line">${escapeHtml(score)}</div>` : ``)
                      + `</div>`;
                  }
                }

                openModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
              });
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        countEl.textContent = `${rows.length} players`;
      }

      function enableSortAndSearch(){
        let sortState = { idx: 0, asc: true };

        function clearIndicators(){
          table.querySelectorAll("thead th").forEach(th => th.classList.remove("sorted-asc","sorted-desc"));
        }

        function sortBy(idx, forceAsc = null){
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const asc =
            (forceAsc === true) ? true :
            (forceAsc === false) ? false :
            (sortState.idx === idx) ? !sortState.asc : true;

          sortState = { idx, asc };
          clearIndicators();
          const th = table.querySelectorAll("thead th")[idx];
          if (th) th.classList.add(asc ? "sorted-asc" : "sorted-desc");

          rows.sort((a,b)=>{
            const av = (a.children[idx]?.textContent ?? "").trim();
            const bv = (b.children[idx]?.textContent ?? "").trim();
            const an = Number(av), bn = Number(bv);
            const anOk = av !== "" && !Number.isNaN(an);
            const bnOk = bv !== "" && !Number.isNaN(bn);
            if (anOk && bnOk) return asc ? (an - bn) : (bn - an);
            return asc ? av.localeCompare(bv) : bv.localeCompare(av);
          });

          rows.forEach(r => tbody.appendChild(r));
        }

        table.querySelectorAll("thead th").forEach((th, idx)=>{
          th.addEventListener("click", ()=>sortBy(idx));
          th.addEventListener("touchend", (e)=>{ e.preventDefault(); sortBy(idx); }, { passive:false });
        });

        function filter(){
          const q = (searchBox.value || "").trim().toLowerCase();
          const rows = Array.from(tbody.querySelectorAll("tr"));
          if (!q) { rows.forEach(r=>r.style.display=""); return; }
          rows.forEach(r=>{
            const a = (r.children[0]?.textContent ?? "").toLowerCase();
            const b = (r.children[1]?.textContent ?? "").toLowerCase();
            const c = (r.children[2]?.textContent ?? "").toLowerCase();
            r.style.display = (a.includes(q) || b.includes(q) || c.includes(q)) ? "" : "none";
          });
        }
        searchBox.addEventListener("input", filter);

        // Rank 1 at top on load
        sortBy(0, true);
      }

      (async function main(){
        try {
          const rankings = await fetchJsonRelative("data/rankings_latest.json");
          if (!Array.isArray(rankings) || rankings.length === 0) throw new Error("No data found in rankings_latest.json");

          renderTable(rankings);
          enableSortAndSearch();

          try {
            matchIndex = await fetchJsonRelative("data/matches_latest.json");
          } catch (e) {
            matchIndex = null; // page still works
          }

          statusEl.textContent = `Loaded • ${new Date().toLocaleString()}`;
        } catch (e) {
          statusEl.textContent = (e && e.message) ? e.message : "Failed to load rankings data.";
        }
      })();
    })();
  </script>
</body>
</html>
