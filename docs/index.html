<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eton Fives Rankings</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; min-height: 20px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .actions a {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; cursor:pointer; text-decoration:none; color:#111; font-size:14px;
    }
    .actions a:hover { background:#f6f6f6; }
    .note { margin: 12px 0 14px; color:#666; font-size: 14px; line-height:1.4; }
    .small { font-size: 12px; color:#666; margin-top:6px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 0 0 12px; }
    .controls input {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; font-size:14px; min-width: 220px;
    }

    .table-wrap{
      border:1px solid #ddd; border-radius:14px; overflow:auto;
      max-height: calc(100vh - 260px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      -webkit-overflow-scrolling: touch;
    }

    table { border-collapse: separate; border-spacing: 0; }
    #rankings{ width: max-content; min-width:100%; background:white; }
    #rankings thead th{
      background:#fafafa;
      border-bottom:1px solid #ddd;
      font-weight:600;
      white-space: nowrap;
      padding: 6px 10px;
      position: sticky; top: 0; z-index: 5;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    #rankings td{
      padding: 6px 10px;
      border-right:1px solid #eee;
      border-bottom:1px solid #eee;
      white-space: nowrap;
      background:white;
    }
    #rankings tbody tr:nth-child(even) td{ background:#fcfcfc; }

    /* Sticky first 3 columns */
    #rankings th:nth-child(1), #rankings td:nth-child(1){
      position: sticky; left: 0; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align: center;;
      font-variant-numeric: tabular-nums;
      background: inherit;
    }
    #rankings th:nth-child(2), #rankings td:nth-child(2){
      position: sticky; left: 60px; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align:center;
      background: inherit;
    }
    #rankings th:nth-child(3), #rankings td:nth-child(3){
      position: sticky; left: 120px; z-index: 6; min-width:190px; max-width:190px;
      border-right:1px solid #ddd;
      font-weight:600;
      background: inherit;
    }

    #rankings td:nth-child(1), #rankings td:nth-child(2), #rankings td:nth-child(3),
    #rankings th:nth-child(1), #rankings th:nth-child(2), #rankings th:nth-child(3){
      background: white;
    }
    #rankings tbody tr:nth-child(even) td:nth-child(1),
    #rankings tbody tr:nth-child(even) td:nth-child(2),
    #rankings tbody tr:nth-child(even) td:nth-child(3){
      background: #fcfcfc;
    }

    .result-cell{ text-align:center; font-weight:600; }

    /* Colour coding (works on mobile because it's inline classes on TD) */
    .res-W{ background:#c6efce !important; color:#006100 !important; }   /* Winner */
    .res-F{ background:#d9e1f2 !important; color:#1f4e79 !important; }   /* Final */
    .res-SF{ background:#fff2cc !important; color:#7f6000 !important; }  /* Semi */
    .res-QF{ background:#fce4d6 !important; color:#7f2a00 !important; }  /* Quarter */
    .res-L16{ background:#fde9d9 !important; color:#7f2a00 !important; } /* Last 16 */
    .res-NQ{ background:#f8cbad !important; color:#833c0c !important; }  /* Non-qual */
    .res-P{ background:#e7e6e6 !important; color:#444 !important; }      /* P */
    .res-UNK{ background:#f2f2f2 !important; color:#555 !important; font-weight:500; }

    th.sorted-asc::after { content:" ▲"; font-weight:700; }
    th.sorted-desc::after { content:" ▼"; font-weight:700; }
  
    /* Modal for match details */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 1000;
    }
    .modal{
      width: min(720px, 100%);
      max-height: min(80vh, 720px);
      overflow:auto;
      background: white;
      border-radius: 16px;
      border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal header{
      position: sticky; top: 0; z-index: 2;
      background: white;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .modal h2{ margin:0; font-size: 18px; }
    .modal .close{
      border: 1px solid #ccc; border-radius: 10px; padding: 8px 10px;
      background: white; cursor: pointer; font-size: 14px;
    }
    .modal .content{ padding: 12px 16px 16px; }
    .match-round{ margin: 14px 0 6px; font-weight: 700; }
    .match{
      padding: 10px 12px; border: 1px solid #eee; border-radius: 12px;
      margin: 8px 0; background: #fafafa;
    }
    .match .line{ margin: 4px 0; }
    .pill{
      display:inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #ddd; background: white; font-size: 12px;
      margin-right: 8px;
    }
    .pill-won{ background:#c6efce; border-color:#9ccc9c; color:#0b5a0b; }
    .pill-lost{ background:#f8cbad; border-color:#f3a981; color:#7f2a00; }

  </style>
</head>

<body>
  <header>
    <div>
      <h1>Eton Fives Rankings</h1>
      <div class="meta" id="status">Loading…</div>
    </div>
    <div class="actions">
      <a href="./downloads/rankings_latest.xlsx" download>Download XLSX</a>
      <a href="./downloads/rankings_latest.csv" download>Download CSV</a>
      <a
        href="https://github.com/thatchersj/rank-the-fives/issues/new?template=submit_results.yml&title=New%20tournament%20results&labels=recalculate"
        target="_blank" rel="noopener"
      >Submit new results</a>
    </div>
  </header>

  <div class="note">
    Tap a column header to sort (mobile supported). Search to find a player.
    <div class="small">Codes: <b>W</b>, <b>F</b>, <b>SF</b>, <b>QF</b>, <b>L16</b>, <b>NQ</b>, <b>P</b>.</div>
  </div>

  <div class="controls">
    <input id="searchBox" type="search" placeholder="Search (rank/initial/surname)..." autocomplete="off" />
    <span class="small" id="count"></span>
  </div>

  <div class="table-wrap">
    <table id="rankings">
      <thead><tr id="theadRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <noscript>
    <p><b>This page needs JavaScript enabled</b> to load rankings.</p>
  </noscript>

  <script>
    (function(){
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const searchBox = document.getElementById("searchBox");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.querySelector("#rankings tbody");
      const table = document.getElementById("rankings");

      function normalizeResult(v) {
        const s = (v ?? "").toString().trim().toUpperCase();
        if (!s) return "";
        return s.replace(/\s+/g, ""); // "L 16" -> "L16"
      }
      function resultClass(v) {
        const key = normalizeResult(v);
        if (!key) return null;
        if (["W","F","SF","QF","NQ","L16","P"].includes(key)) return "res-" + key;
        return "res-UNK";
      }
      function looksLikeResultColumn(colName) {
        // expected like "13 N" / "13N" / "13 K" etc
        return /^\d{2}\s*[NKL]$/i.test(colName.trim().replace(/\s+/g, " "));
      }

      async function loadData() {
        // IMPORTANT: relative to the current page URL (works on GH Pages project sites)
        const url = new URL("data/rankings_latest.json", window.location.href);
        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load ${url} (${res.status} ${res.statusText})`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error("No data found in rankings_latest.json");
        return data;
      }

      async function loadMatches() {
        const url = new URL("data/matches_latest.json", window.location.href);
        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) {
          console.warn("No matches_latest.json", res.status, res.statusText);
          return null;
        }
        return await res.json();
      }

      function render(data) {
        const cols = Object.keys(data[0] || {});
        theadRow.innerHTML = "";
        tbody.innerHTML = "";

        cols.forEach(c => {
          const th = document.createElement("th");
          th.textContent = c;
          th.classList.add("sortable");
          theadRow.appendChild(th);
        });

        const resultCols = new Set(cols.filter(looksLikeResultColumn));

        data.forEach(row => {
          const tr = document.createElement("tr");
          cols.forEach(c => {
            const td = document.createElement("td");
            const val = row[c] ?? "";
            td.textContent = val;

            if (resultCols.has(c)) {
              td.classList.add("result-cell");
              const cls = resultClass(val);
              if (cls) td.classList.add(cls);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        countEl.textContent = `${data.length} players`;
        return cols;
      }

      function enableSortAndSearch() {
        let sortState = { idx: 0, asc: true };

        function clearIndicators(){
          table.querySelectorAll("thead th").forEach(th => th.classList.remove("sorted-asc","sorted-desc"));
        }

        function sortBy(idx, forceAsc = null){
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const asc =
    (forceAsc === true) ? true :
    (forceAsc === false) ? false :
    (sortState.idx === idx) ? !sortState.asc : true;

  sortState = { idx, asc };

  clearIndicators();
  const th = table.querySelectorAll("thead th")[idx];
  th.classList.add(asc ? "sorted-asc" : "sorted-desc");

  rows.sort((a,b)=>{
    const av = (a.children[idx]?.textContent ?? "").trim();
    const bv = (b.children[idx]?.textContent ?? "").trim();
    const an = Number(av), bn = Number(bv);
    const anOk = av !== "" && !Number.isNaN(an);
    const bnOk = bv !== "" && !Number.isNaN(bn);
    if (anOk && bnOk) return asc ? (an - bn) : (bn - an);
    return asc ? av.localeCompare(bv) : bv.localeCompare(av);
  });

  rows.forEach(r => tbody.appendChild(r));
}

        table.querySelectorAll("thead th").forEach((th, idx)=>{
          th.addEventListener("click", ()=>sortBy(idx));
          th.addEventListener("touchend", (e)=>{ if(!looksLikeTournamentCol(th.innerText||th.textContent)) { e.preventDefault(); sortBy(idx); } }, { passive:false });
        });

        function filter(){
          const q = (searchBox.value || "").trim().toLowerCase();
          const rows = Array.from(tbody.querySelectorAll("tr"));
          if (!q) { rows.forEach(r=>r.style.display=""); return; }
          rows.forEach(r=>{
            const a = (r.children[0]?.textContent ?? "").toLowerCase();
            const b = (r.children[1]?.textContent ?? "").toLowerCase();
            const c = (r.children[2]?.textContent ?? "").toLowerCase();
            r.style.display = (a.includes(q) || b.includes(q) || c.includes(q)) ? "" : "none";
          });
        }
        searchBox.addEventListener("input", filter);

        // default sort by Rank ascending (rank 1 at top)
        sortState = { idx: 0, asc: true };
        // force Rank ascending on load (rank 1 at top)
        sortBy(0, true);
      }

      
      function openMatchModal(title, sub, bodyHtml) {
        const backdrop = document.getElementById("matchModalBackdrop");
        const titleEl = document.getElementById("matchModalTitle");
        const subEl = document.getElementById("matchModalSub");
        const bodyEl = document.getElementById("matchModalBody");
        titleEl.textContent = title;
        subEl.textContent = sub || "";
        bodyEl.innerHTML = bodyHtml || "";
        backdrop.style.display = "flex";
        backdrop.setAttribute("aria-hidden", "false");
      }

      function closeMatchModal() {
        const backdrop = document.getElementById("matchModalBackdrop");
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
      }

      function normaliseColumn(s){
        return (s ?? '').toString().replace(/\s+/g,' ').trim().toUpperCase();
      }

      function escapeHtml(s) {
        return (s ?? "").toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      
      function getMatchIndex(){
        return (typeof matchIndex !== 'undefined' && matchIndex) ? matchIndex
          : (typeof matchesIndex !== 'undefined' && matchesIndex) ? matchesIndex
          : (window.matchIndex || window.matchesIndex || null);
      }

      function looksLikeTournamentCol(colText){
        const s = (typeof normaliseColumn === 'function' ? normaliseColumn(colText) : (colText||'').toString().replace(/\s+/g,' ').trim().toUpperCase());
        return /^\d{2}\s*[A-Z]$/.test(s);
      }

      function openTournamentDraw(colText){
        const mi = getMatchIndex();
        if (!mi || !mi.colToKey || !mi.tournaments) return;

        const norm = (typeof normaliseColumn === 'function') ? normaliseColumn(colText) : (colText||'').toString().replace(/\s+/g,' ').trim().toUpperCase();
        const key = mi.colToKey[norm] || mi.colToKey[norm.replace(/\s+/g,'')] || mi.colToKey[norm.replace(/\s+/g,' ')];
        const tourn = key ? mi.tournaments[key] : null;
        if (!tourn) return;

        const title = `${tourn.year} ${tourn.tournament} Draw`;
        const subtitle = `Column: ${norm}`;

        const order = ["Last 16","Quarter-Finals","Semi-Finals","Final"];
        const byRound = {};
        for (const m of (tourn.matches || [])){
          const r = m.round || "Other";
          (byRound[r] ||= []).push(m);
        }

        let body = '';

        const nqTeams = Array.isArray(tourn.nqTeams) ? tourn.nqTeams : [];
        if (nqTeams.length){
          body += `<div class="card"><div style="font-weight:800;font-size:18px;margin-bottom:6px">Non-Qualifiers</div>`;
          body += `<div style="display:flex;flex-wrap:wrap;gap:8px">`;
          for (const t of nqTeams){
            if (!t.team) continue;
            body += `<span class="pill">${escapeHtml(t.team)}</span>`;
          }
          body += `</div></div>`;
        }

        for (const r of order){
          const list = byRound[r] || [];
          if (!list.length) continue;
          body += `<div class="round">${escapeHtml(r)}</div>`;
          for (const m of list){
            const wTeam = m.winnerTeam || '';
            const lTeam = m.loserTeam || '';
            const score = (m.score || '').toString().trim();
            body += `<div class="match">
              <div><b>${escapeHtml(wTeam)}</b> beat ${escapeHtml(lTeam)}</div>
              ${score ? `<div>${escapeHtml(score)}</div>` : ''}
            </div>`;
          }
        }

        const others = Object.keys(byRound).filter(r => !order.includes(r));
        for (const r of others){
          const list = byRound[r] || [];
          if (!list.length) continue;
          body += `<div class="round">${escapeHtml(r)}</div>`;
          for (const m of list){
            const wTeam = m.winnerTeam || '';
            const lTeam = m.loserTeam || '';
            const score = (m.score || '').toString().trim();
            body += `<div class="match">
              <div><b>${escapeHtml(wTeam)}</b> beat ${escapeHtml(lTeam)}</div>
              ${score ? `<div>${escapeHtml(score)}</div>` : ''}
            </div>`;
          }
        }

        if (!body) body = `<div class="card">No draw data found for this tournament.</div>`;

        if (typeof openModal === 'function') {
          openModal(title, subtitle, body);
        } else {
          const mt = document.getElementById('modalTitle');
          const ms = document.getElementById('modalSubtitle');
          const mb = document.getElementById('modalBody');
          const bd = document.getElementById('modalBackdrop') || document.getElementById('backdrop');
          if (mt) mt.textContent = title;
          if (ms) ms.textContent = subtitle;
          if (mb) mb.innerHTML = body;
          if (bd) { bd.style.display = 'flex'; bd.setAttribute('aria-hidden','false'); }
        }
      }
function attachCellClicks(matchesData) {
        const table = document.getElementById("rankings");
        const tbody = table.querySelector("tbody");
        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent);

        const roundOrder = ["L16", "QF", "SF", "F"];
        const roundNames = { L16: "Last 16", QF: "Quarter-Finals", SF: "Semi-Finals", F: "Final" };

        tbody.addEventListener("click", (ev) => {
          const td = ev.target.closest("td");
          if (!td) return;
          const tr = td.parentElement;
          const tds = Array.from(tr.children);
          const colIdx = tds.indexOf(td);
          const colName = (headers[colIdx] || "").trim();

          if (!/^\d{2}\s+[NKL]$/i.test(colName)) return;

          const result = (td.textContent || "").trim();
          if (!result) return;

          const initial = (tds[1]?.textContent || "").trim().toUpperCase();
          const surname = (tds[2]?.textContent || "").trim().toUpperCase();
          const playerKey = `${initial}|${surname}`;

          const tourn = matchesData?.tournaments?.[colName];
          const tournFull = tourn?.tournament || colName;

          let body = "";
          if (!tourn) {
            body = `<div class="match">No match detail found for ${escapeHtml(colName)}.</div>`;
            openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
            return;
          }

          const inNQ = Array.isArray(tourn.nq) && tourn.nq.includes(playerKey);
          const nqTeams = Array.isArray(tourn.nqTeams) ? tourn.nqTeams : [];
          const hitNQTeam = nqTeams.find(t => Array.isArray(t.players) && t.players.includes(playerKey));
          const nqTeamDisplay = (hitNQTeam && hitNQTeam.team) ? hitNQTeam.team : null;


          const matches = (tourn.matches || []).filter(m => {
            const w = Array.isArray(m.winners) ? m.winners : [];
            const l = Array.isArray(m.losers) ? m.losers : [];
            return w.includes(playerKey) || l.includes(playerKey);
          });

                    // Determine the player's team (player + partner) for this tournament
          const prettySurname = (surname || "").slice(0,1) + (surname || "").slice(1).toLowerCase();
          const prettyPlayer = `${initial}.${prettySurname}`;
          let playerTeam = null;
          if (matches.length > 0) {
            const m0 = matches[0];
            const won0 = (m0.winners || []).includes(playerKey);
            playerTeam = won0 ? (m0.winnerTeam || null) : (m0.loserTeam || null);
          }
          if (!playerTeam) playerTeam = prettyPlayer;

          body += `<div class="match"><span class="pill">${escapeHtml(result)}</span><b>${escapeHtml((inNQ && nqTeamDisplay) ? nqTeamDisplay : playerTeam)}</b></div>`;

          if (matches.length === 0 && !inNQ) {
            body += `<div class="match">No match lines found for this player in this tournament.</div>`;
            openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
            return;
          }

          const byRound = {};
          for (const m of matches) {
            const r = m.round || "UNK";
            byRound[r] = byRound[r] || [];
            byRound[r].push(m);
          }

          for (const r of roundOrder) {
            const list = byRound[r];
            if (!list || list.length === 0) continue;
            body += `<div class="match-round">${escapeHtml(roundNames[r])}</div>`;
            for (const m of list) {
              const wTeam = escapeHtml(m.winnerTeam || "");
              const lTeam = escapeHtml(m.loserTeam || "");
              const score = escapeHtml(m.score || "");
              const won = (m.winners || []).includes(playerKey);
              const side = won ? "Won" : "Lost";
              body += `<div class="match">` +
                      `<div class="line"><span class="pill ${won ? "pill-won" : "pill-lost"}">${escapeHtml(won ? "Won" : "Lost")}</span><I>vs</I> ${escapeHtml(won ? (m.loserTeam || "") : (m.winnerTeam || ""))}</div>` +
                      (score ? `<div class="line">${score}</div>` : ``) +
                      `</div>`;
            }
          }

          openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
        });

        document.getElementById("matchModalClose")?.addEventListener("click", closeMatchModal);
        document.getElementById("matchModalBackdrop")?.addEventListener("click", (e) => {
          if (e.target && e.target.id === "matchModalBackdrop") closeMatchModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeMatchModal();
        });
      }

      (async function main(){
        try {
          const [data, matchesData] = await Promise.all([loadData(), loadMatches()]);
          render(data);
          enableSortAndSearch();
          attachCellClicks(matchesData);
          statusEl.textContent = `Loaded • ${new Date().toLocaleString()}`;
        } catch (e) {
          console.error(e);
          statusEl.textContent = (e && e.message) ? e.message : "Failed to load rankings data.";
        }
      })();
    })();
  </script>

  <div class="modal-backdrop" id="matchModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="matchModal">
      <header>
        <div>
          <h2 id="matchModalTitle">Match details</h2>
          <div class="small" id="matchModalSub"></div>
        </div>
        <button class="close" id="matchModalClose" type="button">Close</button>
      </header>
      <div class="content" id="matchModalBody"></div>
    </div>
  </div>

</body>
</html>