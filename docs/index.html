<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eton Fives Rankings</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; min-height: 20px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .actions a {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; cursor:pointer; text-decoration:none; color:#111; font-size:14px;
    }
    .actions a:hover { background:#f6f6f6; }
    .note { margin: 12px 0 14px; color:#666; font-size: 14px; line-height:1.4; }
    .small { font-size: 12px; color:#666; margin-top:6px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 0 0 12px; }
    .controls input {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; font-size:14px; min-width: 220px;
    }

    .table-wrap{
      border:1px solid #ddd; border-radius:14px; overflow:auto;
      max-height: calc(100vh - 260px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      -webkit-overflow-scrolling: touch;
    }

    table { border-collapse: separate; border-spacing: 0; }
    #rankings{ width: max-content; min-width:100%; background:white; }
    #rankings thead th{
      background:#fafafa;
      border-bottom:1px solid #ddd;
      font-weight:600;
      white-space: nowrap;
      padding: 6px 10px;
      position: sticky; top: 0; z-index: 5;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    #rankings td{
      padding: 6px 10px;
      border-right:1px solid #eee;
      border-bottom:1px solid #eee;
      white-space: nowrap;
      background:white;
    }
    #rankings tbody tr:nth-child(even) td{ background:#fcfcfc; }

    /* Sticky first 3 columns */
    #rankings th:nth-child(1), #rankings td:nth-child(1){
      position: sticky; left: 0; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align: right;
      font-variant-numeric: tabular-nums;
      background: inherit;
    }
    #rankings th:nth-child(2), #rankings td:nth-child(2){
      position: sticky; left: 60px; z-index: 6; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align:center;
      background: inherit;
    }
    #rankings th:nth-child(3), #rankings td:nth-child(3){
      position: sticky; left: 120px; z-index: 6; min-width:190px; max-width:190px;
      border-right:1px solid #ddd;
      font-weight:600;
      background: inherit;
    }

    #rankings td:nth-child(1), #rankings td:nth-child(2), #rankings td:nth-child(3),
    #rankings th:nth-child(1), #rankings th:nth-child(2), #rankings th:nth-child(3){
      background: white;
    }
    #rankings tbody tr:nth-child(even) td:nth-child(1),
    #rankings tbody tr:nth-child(even) td:nth-child(2),
    #rankings tbody tr:nth-child(even) td:nth-child(3){
      background: #fcfcfc;
    }

    .result-cell{ text-align:center; font-weight:600; }

    /* Colour coding */
    .res-W{ background:#c6efce !important; color:#006100 !important; }
    .res-F{ background:#d9e1f2 !important; color:#1f4e79 !important; }
    .res-SF{ background:#fff2cc !important; color:#7f6000 !important; }
    .res-QF{ background:#fce4d6 !important; color:#7f2a00 !important; }
    .res-L16{ background:#fde9d9 !important; color:#7f2a00 !important; }
    .res-NQ{ background:#f8cbad !important; color:#833c0c !important; }
    .res-P{ background:#e7e6e6 !important; color:#444 !important; }
    .res-UNK{ background:#f2f2f2 !important; color:#555 !important; font-weight:500; }

    th.sorted-asc::after { content:" ▲"; font-weight:700; }
    th.sorted-desc::after { content:" ▼"; font-weight:700; }
  
    /* Modal for match details */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 1000;
    }
    .modal{
      width: min(720px, 100%);
      max-height: min(80vh, 720px);
      overflow:auto;
      background: white;
      border-radius: 16px;
      border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal header{
      position: sticky; top: 0; z-index: 2;
      background: white;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .modal h2{ margin:0; font-size: 18px; }
    .modal .close{
      border: 1px solid #ccc; border-radius: 10px; padding: 8px 10px;
      background: white; cursor: pointer; font-size: 14px;
    }
    .modal .content{ padding: 12px 16px 16px; }
    .match-round{ margin: 14px 0 6px; font-weight: 700; }
    .match{
      padding: 10px 12px; border: 1px solid #eee; border-radius: 12px;
      margin: 8px 0; background: #fafafa;
    }
    .match .line{ margin: 4px 0; }
    .pill{
      display:inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid #ddd; background: white; font-size: 12px;
      margin-right: 8px;
    }
    .pill-won{ background:#c6efce; border-color:#9ccc9c; color:#0b5a0b; }
    .pill-lost{ background:#f8cbad; border-color:#f3a981; color:#7f2a00; }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>Eton Fives Rankings</h1>
      <div class="meta" id="status">Loading…</div>
    </div>
    <div class="actions">
      <a href="./downloads/rankings_latest.xlsx" download>Download XLSX</a>
      <a href="./downloads/rankings_latest.csv" download>Download CSV</a>
      <a
        href="https://github.com/thatchersj/rank-the-fives/issues/new?template=submit_results.yml&title=New%20tournament%20results&labels=recalculate"
        target="_blank" rel="noopener"
      >Submit new results</a>
    </div>
  </header>

  <div class="note">
    Tap a column header to sort. Search to find a player.
    <div class="small">Codes: <b>W</b>, <b>F</b>, <b>SF</b>, <b>QF</b>, <b>L16</b>, <b>NQ</b>, <b>P</b>.</div>
  </div>

  <div class="controls">
    <input id="searchBox" type="search" placeholder="Search (rank/initial/surname)..." autocomplete="off" />
    <span class="small" id="count"></span>
  </div>

  <div class="table-wrap">
    <table id="rankings">
      <thead><tr id="theadRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <noscript>
    <p><b>This page needs JavaScript enabled</b> to load rankings.</p>
  </noscript>

  <div class="modal-backdrop" id="matchModalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="matchModal">
      <header>
        <div>
          <h2 id="matchModalTitle">Match details</h2>
          <div class="small" id="matchModalSub"></div>
        </div>
        <button class="close" id="matchModalClose" type="button">Close</button>
      </header>
      <div class="content" id="matchModalBody"></div>
    </div>
  </div>

  <script>
    (function(){
      const statusEl = document.getElementById("status");
      const countEl = document.getElementById("count");
      const searchBox = document.getElementById("searchBox");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.querySelector("#rankings tbody");
      const table = document.getElementById("rankings");

      function normalizeResult(v) {
        const s = (v ?? "").toString().trim().toUpperCase();
        if (!s) return "";
        return s.replace(/\s+/g, "");
      }

      function resultClass(v) {
        const key = normalizeResult(v);
        if (!key) return null;
        if (["W","F","SF","QF","NQ","L16","P"].includes(key)) return "res-" + key;
        return "res-UNK";
      }

      function looksLikeResultColumn(colName) {
        return /^\d{2}\s*[NKL]$/i.test(colName.trim().replace(/\s+/g, " "));
      }

      function normColKey(s) {
        return (s ?? "").toString().trim().replace(/\s+/g, " ");
      }

      async function loadData() {
        const url = new URL("data/rankings_latest.json", window.location.href);
        const res = await fetch(url.toString(), { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load data`);
        return await res.json();
      }

      async function loadMatches() {
        const url = new URL("data/matches_latest.json", window.location.href);
        try {
          const res = await fetch(url.toString(), { cache: "no-store" });
          if (!res.ok) return null;
          return await res.json();
        } catch (e) { return null; }
      }

      function render(data) {
        const cols = Object.keys(data[0] || {});
        theadRow.innerHTML = "";
        tbody.innerHTML = "";

        cols.forEach(c => {
          const th = document.createElement("th");
          th.textContent = c;
          th.classList.add("sortable");
          theadRow.appendChild(th);
        });

        const resultCols = new Set(cols.filter(looksLikeResultColumn));

        data.forEach(row => {
          const tr = document.createElement("tr");
          cols.forEach(c => {
            const td = document.createElement("td");
            const val = row[c] ?? "";
            td.textContent = val;
            if (resultCols.has(c)) {
              td.classList.add("result-cell");
              const cls = resultClass(val);
              if (cls) td.classList.add(cls);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        countEl.textContent = `${data.length} players`;
        return cols;
      }

      function enableSortAndSearch() {
        let sortState = { idx: 0, asc: true };

        function clearIndicators(){
          table.querySelectorAll("thead th").forEach(th => th.classList.remove("sorted-asc","sorted-desc"));
        }

        function sortBy(idx, forceAsc = null){
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const asc = (forceAsc === true) ? true : (forceAsc === false) ? false : (sortState.idx === idx) ? !sortState.asc : true;
          sortState = { idx, asc };
          clearIndicators();
          const th = table.querySelectorAll("thead th")[idx];
          if(th) th.classList.add(asc ? "sorted-asc" : "sorted-desc");

          rows.sort((a,b)=>{
            const av = (a.children[idx]?.textContent ?? "").trim();
            const bv = (b.children[idx]?.textContent ?? "").trim();
            const an = Number(av), bn = Number(bv);
            if (!isNaN(an) && !isNaN(bn) && av !== "" && bv !== "") return asc ? (an - bn) : (bn - an);
            return asc ? av.localeCompare(bv) : bv.localeCompare(av);
          });
          rows.forEach(r => tbody.appendChild(r));
        }

        table.querySelectorAll("thead th").forEach((th, idx)=>{
          th.addEventListener("click", ()=>sortBy(idx));
        });

        searchBox.addEventListener("input", ()=>{
          const q = searchBox.value.toLowerCase().trim();
          Array.from(tbody.querySelectorAll("tr")).forEach(r=>{
            const text = r.textContent.toLowerCase();
            r.style.display = text.includes(q) ? "" : "none";
          });
        });

        sortBy(0, true);
      }

      function openMatchModal(title, sub, bodyHtml) {
        document.getElementById("matchModalTitle").textContent = title;
        document.getElementById("matchModalSub").textContent = sub || "";
        document.getElementById("matchModalBody").innerHTML = bodyHtml || "";
        document.getElementById("matchModalBackdrop").style.display = "flex";
      }

      function closeMatchModal() {
        document.getElementById("matchModalBackdrop").style.display = "none";
      }

      function escapeHtml(s) {
        return (s ?? "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function attachCellClicks(matchesData) {
        const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent);
        const roundOrder = ["L16", "QF", "SF", "F"];
        const roundNames = { L16: "Last 16", QF: "Quarter-Finals", SF: "Semi-Finals", F: "Final" };

        tbody.addEventListener("click", (ev) => {
          const td = ev.target.closest("td");
          if (!td) return;
          const tr = td.parentElement;
          const tds = Array.from(tr.children);
          const colIdx = tds.indexOf(td);
          const colName = (headers[colIdx] || "").trim();

          if (!looksLikeResultColumn(colName)) return;

          const result = (td.textContent || "").trim();
          if (!result) return;

          const initial = (tds[1]?.textContent || "").trim().toUpperCase();
          const surname = (tds[2]?.textContent || "").trim().toUpperCase();
          const playerKey = `${initial}.${surname}`;

          const colKey1 = normColKey(colName);
          const colKey2 = colKey1.replace(/\s+/g, "");
          const tourn = matchesData?.tournaments?.[colKey1] || matchesData?.tournaments?.[colKey2];
          const tournFull = (tourn && tourn.year && tourn.tournament) ? `${tourn.year} ${tourn.tournament}` : colName;

          let body = "";
          if (!tourn) {
            body = `<div class="match">No match detail found for ${escapeHtml(colName)}.</div>`;
            openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
            return;
          }

          const matches = (tourn.matches || []).filter(m => {
            const w = Array.isArray(m.winners) ? m.winners : [];
            const l = Array.isArray(m.losers) ? m.losers : [];
            return w.includes(playerKey) || l.includes(playerKey);
          });

          if (matches.length === 0) {
            body += `<div class="match">No match lines found for this player.</div>`;
          } else {
            const byRound = {};
            matches.forEach(m => {
              const r = m.round || "UNK";
              if (!byRound[r]) byRound[r] = [];
              byRound[r].push(m);
            });

            roundOrder.forEach(r => {
              if (!byRound[r]) return;
              body += `<div class="match-round">${escapeHtml(roundNames[r])}</div>`;
              byRound[r].forEach(m => {
                const won = (m.winners || []).includes(playerKey);
                body += `<div class="match">
                  <span class="pill ${won ? "pill-won" : "pill-lost"}">${won ? "Won" : "Lost"}</span>
                  <div class="line"><b>${won ? "beat" : "lost to"}</b> ${escapeHtml(won ? m.loserTeam : m.winnerTeam)}</div>
                  ${m.score ? `<div class="line">${escapeHtml(m.score)}</div>` : ''}
                </div>`;
              });
            });
          }
          openMatchModal(`${initial}. ${surname}`, `${tournFull} (${result})`, body);
        });

        document.getElementById("matchModalClose")?.addEventListener("click", closeMatchModal);
        document.getElementById("matchModalBackdrop")?.addEventListener("click", (e) => {
          if (e.target.id === "matchModalBackdrop") closeMatchModal();
        });
        document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMatchModal(); });
      }

      (async function main(){
        try {
          const [data, matchesData] = await Promise.all([loadData(), loadMatches()]);
          render(data);
          enableSortAndSearch();
          attachCellClicks(matchesData);
          statusEl.textContent = `Loaded • ${new Date().toLocaleTimeString()}`;
        } catch (e) {
          console.error(e);
          statusEl.textContent = "Error loading rankings data.";
        }
      })();
    })();
  </script>
</body>
</html>
