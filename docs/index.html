<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eton Fives Rankings</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.8/css/dataTables.dataTables.min.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .actions a, .actions button {
      appearance:none; border:1px solid #ccc; border-radius:10px; padding:10px 12px;
      background:white; cursor:pointer; text-decoration:none; color:#111; font-size:14px;
    }
    .actions a:hover, .actions button:hover { background:#f6f6f6; }
    .note { margin: 12px 0 18px; color:#666; font-size: 14px; line-height:1.4; }
    table.dataTable thead th { white-space: nowrap; }
    .small { font-size: 12px; color:#666; }

    .table-wrap{
      border:1px solid #ddd; border-radius:14px; overflow:auto;
      max-height: calc(100vh - 220px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    /* Make the table feel more like the XLSX */
    table.dataTable thead th{
      background:#fafafa;
      border-bottom:1px solid #ddd !important;
      font-weight:600;
    }
    table.dataTable td, table.dataTable th{
      padding: 6px 10px !important;
      border-right:1px solid #eee;
      white-space: nowrap;
    }
    table.dataTable tbody td{ border-bottom:1px solid #eee; }
    #rankings{ width: max-content; min-width:100%; }
    /* Sticky header (works inside overflow container) */
    #rankings thead th{ position: sticky; top: 0; z-index: 3; }
    /* Sticky first 3 columns */
    #rankings th:nth-child(1), #rankings td:nth-child(1){
      position: sticky; left: 0; z-index: 4; background: inherit; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    #rankings th:nth-child(2), #rankings td:nth-child(2){
      position: sticky; left: 60px; z-index: 4; background: inherit; min-width:60px; max-width:60px;
      border-right:1px solid #ddd;
      text-align:center;
    }
    #rankings th:nth-child(3), #rankings td:nth-child(3){
      position: sticky; left: 120px; z-index: 4; background: inherit; min-width:190px; max-width:190px;
      border-right:1px solid #ddd;
      font-weight:600;
    }
    /* Ensure sticky cells paint over scrolled content */
    #rankings td:nth-child(1), #rankings td:nth-child(2), #rankings td:nth-child(3),
    #rankings th:nth-child(1), #rankings th:nth-child(2), #rankings th:nth-child(3){
      background: white;
    }
    table.dataTable tbody tr:nth-child(even) td:nth-child(1),
    table.dataTable tbody tr:nth-child(even) td:nth-child(2),
    table.dataTable tbody tr:nth-child(even) td:nth-child(3){
      background: #fcfcfc;
    }
    /* Center tournament result cells */
    .result-cell{ text-align:center; font-weight:600; }
    /* Colour coding (Excel-ish) */
    .res-W{ background:#c6efce !important; color:#006100 !important; }  /* Winner */
    .res-F{ background:#d9e1f2 !important; color:#1f4e79 !important; }  /* Final */
    .res-SF{ background:#fff2cc !important; color:#7f6000 !important; } /* Semi */
    .res-QF{ background:#fce4d6 !important; color:#7f2a00 !important; } /* Quarter */
    .res-L16{ background:#fde9d9 !important; color:#7f2a00 !important; } /* Last 16 */
    .res-NQ{ background:#f8cbad !important; color:#833c0c !important; } /* Non-qual */
    .res-P{ background:#e7e6e6 !important; color:#444 !important; }     /* Plate/Prelim */
    .res-DNS{ background:#efefef !important; color:#666 !important; font-weight:500; }
    .res-UNK{ background:#f2f2f2 !important; color:#555 !important; font-weight:500; }

  </style>
</head>
<body>
  <header>
    <div>
      <h1>Eton Fives Rankings</h1>
      <div class="meta" id="lastUpdated">Loadingâ€¦</div>
    </div>
    <div class="actions">
      <a href="./downloads/rankings_latest.xlsx" download>Download XLSX</a>
      <a href="./downloads/rankings_latest.csv" download>Download CSV</a>
      <a href="https://github.com/" id="issueLink" target="_blank" rel="noopener">Submit new results (GitHub Issue)</a>
    </div>
  </header>

  <div class="note">
    Search, sort, and filter the live rankings below. Cells show best finish per tournament: <b>W</b>, <b>F</b>, <b>SF</b>, <b>QF</b>, <b>L16</b>, <b>NQ</b>, and <b>P</b> (did not play).
    <div class="small">Tip: click a column header to sort, or use the search box to find a player.</div>
  </div>

  <div class="table-wrap"><table id="rankings" class="display compact stripe" style="width:100%">
    <thead><tr id="theadRow"></tr></thead>
    <tbody></tbody>
  </table></div>

  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.8/js/dataTables.min.js"></script>
  <script>
    async function main() {
      const repo = (new URLSearchParams(location.search)).get("repo");
      const issueLink = document.getElementById("issueLink");
      if (repo) issueLink.href = `https://github.com/${repo}/issues/new?template=submit_results.yml`;

      const res = await fetch("./data/rankings_latest.json", {cache: "no-store"});
      const data = await res.json();

      if (!data.length) {
        document.getElementById("lastUpdated").textContent = "No data found.";
        return;
      }

      const cols = Object.keys(data[0]);

      // Header
      const thead = document.getElementById("theadRow");
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        thead.appendChild(th);
      });

      // Rows
      const tbody = document.querySelector("#rankings tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td");
          td.textContent = (row[c] ?? "");
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // Last updated from the first row's Rankings file timestamp via HTTP header not available on GH Pages;
      // so we display today's date from the browser.
      const now = new Date();
      document.getElementById("lastUpdated").textContent = `Last updated: ${now.toLocaleString()}`;

      // Identify tournament-result columns (e.g. "24 K")
      const resultColIdx = cols
        .map((c, i) => ({c, i}))
        .filter(({c}) => /^\d{2}\s+[NKL]$/.test(c))
        .map(({i}) => i);

      function resultClass(v) {
        const s = (v ?? "").toString().trim();
        if (!s) return null;
        const key = s.replace(/\s+/g, "");
        if (["W","F","SF","QF","NQ","L16","P","DNS"].includes(key)) return "res-" + key;
        return "res-UNK";
      }

      new DataTable("#rankings", {
        pageLength: 25,
        scrollX: false,
        order: [[0, "asc"]],
        drawCallback: function() {
          const api = this.api();
          resultColIdx.forEach(idx => {
            api.column(idx, {page:"current"}).nodes().each(td => {
              td.classList.add("result-cell");
              // Remove any previous res-* class
              [...td.classList].forEach(c => { if (c.startsWith("res-")) td.classList.remove(c); });
              const cls = resultClass(td.textContent);
              if (cls) td.classList.add(cls);
            });
          });
        }
      });
}
    main().catch(err => {
      document.getElementById("lastUpdated").textContent = "Failed to load rankings data.";
      console.error(err);
    });
  </script>
</body>
</html>
